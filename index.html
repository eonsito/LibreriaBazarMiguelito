<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librer√≠a Bazar Miguelito | App de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* (Estilos CSS - sin cambios) */
        :root {
            --color-primary: #1e40af;
            --color-accent: #f59e0b; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .title-font {
            font-family: 'Poppins', sans-serif;
            color: var(--color-primary);
        }
        .logo-image {
            width: 180px; 
            height: auto;
            object-fit: contain;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .module-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--color-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .module-button:hover {
            background-color: #1d4ed8;
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .category-button {
            transition: all 0.2s;
            background-color: #eef2ff;
            color: var(--color-primary);
            border: 2px solid #c7d2fe;
        }
        .category-button:hover {
            background-color: #c7d2fe;
            transform: translateY(-1px);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .price-table-header {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 700;
            border-radius: 0.5rem 0.5rem 0 0;
            text-transform: uppercase;
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .price-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="selection:bg-yellow-300 selection:text-gray-900">

    <div id="appContainer" class="w-full max-w-4xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100 transition-all duration-300 relative">

        <button onclick="showAdminPasswordModal()" 
            class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors shadow-lg z-20">
            JEFE
        </button>
        <header class="text-center mb-10">
            <img src="img/logo.jpg" alt="Logo de la Librer√≠a" class="logo-image">
            <h1 class="title-font text-3xl sm:text-5xl font-extrabold tracking-tight mb-2">
                Librer√≠a Bazar Miguelito
            </h1>
            <p id="appSubtitle" class="text-gray-500 text-lg sm:text-xl font-medium">
                Portal de Recursos para Asesores de Venta
            </p>
        </header>

        <div id="mainMenu" class="transition-opacity duration-300">
            <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button class="module-button flex flex-col items-center justify-center p-6 text-white rounded-xl h-40"
                        onclick="showCategories()">
                    <i data-lucide="tags" class="w-8 h-8 mb-2"></i>
                    <span class="text-xl font-semibold">Precios</span>
                    <span class="text-sm font-light opacity-80">Tarifas y Cat√°logo</span>
                </button>
                <button class="module-button flex flex-col items-center justify-center p-6 text-white rounded-xl h-40"
                        onclick="showRecommendations()">
                    <i data-lucide="lightbulb" class="w-8 h-8 mb-2"></i>
                    <span class="text-xl font-semibold">Recomendaciones</span>
                    <span class="text-sm font-light opacity-80">Ideas y Sugerencias</span>
                </button>
                <button class="module-button flex flex-col items-center justify-center p-6 text-white rounded-xl h-40"
                        onclick="showMessage('Contacto Administrativo', '<p class=text-gray-600 mb-6 text-center>Para consultas urgentes, por favor contacte a su supervisor directo o al correo: admin@miguelito.com.</p><button onclick=hideModal(event) class=w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition duration-150 shadow-md>Entendido</button>')">
                    <i data-lucide="users" class="w-8 h-8 mb-2"></i>
                    <span class="text-xl font-semibold">Contacto</span>
                    <span class="text-sm font-light opacity-80">Soporte y Consultas</span>
                </button>
            </main>
        </div>

        <div id="categoriesView" class="hidden transition-opacity duration-300">
            <button onclick="showMainMenu()" class="text-gray-500 hover:text-gray-700 font-semibold mb-6 flex items-center">
                <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
                <span>Volver al Men√∫ Principal</span>
            </button>
            <h2 id="categoryTitle" class="text-3xl title-font font-bold mb-6 border-b pb-2">Seleccione una Categor√≠a</h2>
            <div class="mb-6">
                <input type="text" id="searchInput" oninput="liveSearch()"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-inner" 
                    placeholder="üîç Buscar productos por nombre (Ej: Cuaderno, Goma)" aria-label="Buscar productos">
            </div>
            <div id="categoriesContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                <p id="loadingMessage" class="col-span-full text-center text-gray-500">Cargando datos. Por favor espere...</p>
            </div>
        </div>

        <div id="productsView" class="hidden transition-opacity duration-300">
            <button onclick="showCategories()" class="text-gray-500 hover:text-gray-700 font-semibold mb-6 flex items-center">
                <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
                <span id="backToCategoriesText">Volver a Categor√≠as</span>
            </button>
            <h2 id="productsTitle" class="text-3xl title-font font-bold mb-6 border-b pb-2">Productos en [Categor√≠a]</h2>
            <div id="productsListContainer" class="bg-white rounded-lg border border-gray-200 divide-y divide-gray-100">
            </div>
        </div>
        
        <div id="recommendationsView" class="hidden transition-opacity duration-300">
            <button onclick="showMainMenu()" class="text-gray-500 hover:text-gray-700 font-semibold mb-6 flex items-center">
                <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
                <span>Volver al Men√∫ Principal</span>
            </button>
            <div id="zivaContentContainer" class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 border border-gray-200 text-gray-800">
            </div>
        </div>

        <div id="adminView" class="hidden transition-opacity duration-300">
            <button onclick="exitAdminMode()" class="text-gray-500 hover:text-gray-700 font-semibold mb-6 flex items-center">
                <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                <span>Salir Modo Jefe</span>
            </button>
            <h2 class="text-3xl title-font font-bold mb-6 border-b pb-2 text-red-600">Gesti√≥n de Cat√°logo (Modo Jefe)</h2>
            <div class="bg-red-50 p-6 rounded-xl mb-8 border border-red-200">
                <h3 class="text-xl font-bold text-red-700 mb-4 flex justify-between items-center">
                    Categor√≠as
                    <button onclick="showAddCategoryModal()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-1 px-3 rounded-full transition-colors shadow-md flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                        Nueva Categor√≠a
                    </button>
                </h3>
                <div id="adminCategoriesContainer" class="space-y-3">
                </div>
            </div>
            <div id="adminProductsSection" class="bg-gray-50 p-6 rounded-xl border border-gray-200 hidden">
                <h3 id="adminProductsTitle" class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Productos en [Categor√≠a]</h3>
                <button onclick="showAddProductModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded-full mb-4 transition-colors shadow-md flex items-center">
                    <i data-lucide="package-plus" class="w-4 h-4 mr-1"></i>
                    A√±adir Producto
                </button>
                <div id="adminProductsList" class="space-y-2">
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-400 text-sm">
            &copy; 2025 Librer√≠a Bazar Miguelito | Sistema Interno V1.0
        </footer>
    </div>
    <div id="customModal" class="modal-overlay" onclick="hideModal(event)">
        <div id="modalContent" class="modal-content" onclick="event.stopPropagation()">
        </div>
    </div>

    <script type="module">
        // Importaci√≥n de Firebase Modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        
        // üõë SECCI√ìN DE CONFIGURACI√ìN DE FIREBASE (INTEGRADA) üõë
        // Estas son las credenciales que proporcionaste
        const REAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDNGZTWgOlBDXG_VRPt88ezvWQznzvN5_o",
            authDomain: "libreria-bazar-miguelito.firebaseapp.com",
            projectId: "libreria-bazar-miguelito",
            storageBucket: "libreria-bazar-miguelito.firebasestorage.app",
            messagingSenderId: "493141456239",
            appId: "1:493141456239:web:1e0c0176935fe9fcb6249a",
            measurementId: "G-8LECLW25RG"
        };
        
        // Asignamos tus credenciales a las variables que usa la app
        const appId = REAL_FIREBASE_CONFIG.projectId;
        const firebaseConfig = REAL_FIREBASE_CONFIG;
        const initialAuthToken = null; 
        // üõë FIN DE LA SECCI√ìN DE CONFIGURACI√ìN üõë


        // Exponer Firebase para el script principal
        window.appId = appId;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.isFirebaseActive = false; // Flag para saber si Firebase est√° conectado

        // Funci√≥n de autenticaci√≥n e inicializaci√≥n
        async function authenticateUser() {
            // CORRECCI√ìN: Verificamos si la config tiene un projectId, 
            // ya que la config vac√≠a {} (de un sandbox) no lo tendr√≠a.
            if (!firebaseConfig.projectId) { 
                console.error("Firebase config not found. Running in local-only mode.");
                window.userId = crypto.randomUUID(); 
                
                // --- FIX PARA ERROR 1 (CRASH) ---
                // No intentamos ocultar 'loadingMessage' aqu√≠.
                // Solo llamamos a la funci√≥n de carga local (que se define en el pr√≥ximo script).
                // 'startFirebaseListeners' se llamar√°, ver√° que window.db es null, y cargar√° localmente.
                window.startFirebaseListeners();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.isFirebaseActive = true; // Marcamos Firebase como activo
                setLogLevel('Debug'); 

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase Authenticated. User ID:", window.userId);
                    } else {
                        window.userId = crypto.randomUUID(); 
                        console.log("Firebase running anonymously. User ID:", window.userId);
                    }
                    window.startFirebaseListeners(); // Inicia la escucha despu√©s de la autenticaci√≥n
                });

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                window.userId = crypto.randomUUID(); 
                window.startFirebaseListeners(); // Intentar cargar localmente si la autenticaci√≥n falla
            }
        }
        
        // CORRECCI√ìN PARA ERROR 1 (CRASH):
        // Esperamos a que todo el HTML est√© cargado (DOMContentLoaded) antes de intentar conectar.
        // Esto asegura que el script 2 (con 'loadingMessage') est√© listo.
        document.addEventListener('DOMContentLoaded', () => {
            authenticateUser();
        });
    </script>

    <script>
        // Inicializar iconos de Lucide
        lucide.createIcons();

        // 1. DATA (Datos iniciales hardcodeados)
        window.appData = {
            categories: [ 
                { // ----------------- CATEGOR√çA 1: MATERIAL ESCOLAR -----------------
                    id: 'mat_escolar', 
                    name: 'MATERIAL ESCOLAR',
                    products: [
                        { nombre: 'Acuarelas Faber-Castell', precio: 10.0 },
                        { nombre: 'Apu', precio: 2.5 },
                        { nombre: 'Borrador Blanco Grande', precio: 1.0 },
                        { nombre: 'Borrador Chico Blanco', precio: 0.5 },
                        { nombre: 'Borrador para Tinta', precio: 0.5 },
                        { nombre: 'Caja Deligas', precio: 4.0 },
                        { nombre: 'Cartucheras Derecha', precio: 8.0 },
                        { nombre: 'Cartucheras Izquierda', precio: 10.0 },
                        { nombre: 'Cartulina Canson', precio: 3.0 },
                        { nombre: 'Chenil', precio: 4.0 },
                        { nombre: 'Color Jumbo Vikingo', precio: 13.0 },
                        { nombre: 'Color Vinifan', precio: 6.0 },
                        { nombre: 'Coloreando', precio: 1.0 },
                        { nombre: 'Colores Alpha', precio: 6.5 },
                        { nombre: 'Colores Chicos Vikingo', precio: 3.5 },
                        { nombre: 'Colores Faber-Castell', precio: 7.0 },
                        { nombre: 'Colores Maped', precio: 6.5 },
                        { nombre: 'Colores Pep Strong', precio: 5.5 },
                        { nombre: 'Colores Vikingo Acuarelables', precio: 6.5 },
                        { nombre: 'Corrector Artesco', precio: 2.0 },
                        { nombre: 'Corrector Vinifan', precio: 2.0 },
                        { nombre: 'Crayolas Artesco', precio: 5.0 },
                        { nombre: 'Crayones Chicos Vikingo', precio: 3.0 },
                        { nombre: 'Cuadernillo De Hojas Cuadriculadas', precio: 1.5 },
                        { nombre: 'Cuaderno Anillado Iris Color Chico', precio: 15.0 },
                        { nombre: 'Cuaderno College', precio: 6.5 },
                        { nombre: 'Cuaderno Inbox', precio: 3.5 },
                        { nombre: 'Cuaderno Justus', precio: 4.5 },
                        { nombre: 'Cuaderno Loro', precio: 5.5 },
                        { nombre: 'Cuaderno Stanford', precio: 7.0 },
                        { nombre: 'Cuento Infantil', precio: 5.0 },
                        { nombre: 'Flauta', precio: 5.0 },
                        { nombre: 'Forro F√°cil', precio: 1.5 },
                        { nombre: 'Goma Artesco Vinifan', precio: 3.8 },
                        { nombre: 'Goma David', precio: 1.5 },
                        { nombre: 'Goma De Pote Gogita', precio: 2.8 },
                        { nombre: 'Goma En Barra 20 Gr', precio: 3.0 },
                        { nombre: 'Goma En Barra 40 Gr', precio: 4.0 },
                        { nombre: 'Goma En Barra 8 Gr', precio: 1.0 },
                        { nombre: 'Goma Faber-Castell 225 Gr', precio: 3.8 },
                        { nombre: 'Goma Gotita', precio: 1.0 },
                        { nombre: 'Hilo Pabilo', precio: 0.5 },
                        { nombre: 'Labios', precio: 0.3 },
                        { nombre: 'Lapicero Artesco Borrador', precio: 3.5 },
                        { nombre: 'Lapiceros Escarchados', precio: 6.0 },
                        { nombre: 'L√°piz Mongol', precio: 1.0 },
                        { nombre: 'L√°piz T√©cnico', precio: 1.5 },
                        { nombre: 'L√°piz Vinifan', precio: 0.6 },
                        { nombre: 'Mandil De Pl√°stico', precio: 6.0 },
                        { nombre: 'Ojos Movibles Par', precio: 0.5 },
                        { nombre: 'Ovillo De Lana', precio: 1.0 },
                        { nombre: 'Paleta De Colores', precio: 3.0 },
                        { nombre: 'Palitos Chupete', precio: 1.5 },
                        { nombre: 'Pistola De Silicona Econ√≥mica', precio: 5.0 },
                        { nombre: 'Pistola Para Silicona MercyFan', precio: 10.0 },
                        { nombre: 'Plancha De Foamy Escarchado', precio: 5.0 },
                        { nombre: 'Plancha De Monedas Y Billetes', precio: 2.5 },
                        { nombre: 'Plastilinas Ne√≥n', precio: 6.0 },
                        { nombre: 'Platilinas Artesco', precio: 4.5 },
                        { nombre: 'Plumon De Pizarra Artesco', precio: 2.0 },
                        { nombre: 'Plumon De Pizarra Vikingo', precio: 2.0 },
                        { nombre: 'Plumones Delgados Artesco', precio: 7.0 },
                        { nombre: 'Plumones Para Papelote', precio: 1.8 },
                        { nombre: 'Pomp√≥n Met√°licos', precio: 4.0 },
                        { nombre: 'Rafia', precio: 1.0 },
                        { nombre: 'Serpentina', precio: 1.5 },
                        { nombre: 'Silbato', precio: 1.0 },
                        { nombre: 'Silicona 100 Ml', precio: 4.0 },
                        { nombre: 'Silicona 250 Ml', precio: 6.5 },
                        { nombre: 'Silicona 30 Ml', precio: 2.0 },
                        { nombre: 'Stickers', precio: 1.0 },
                        { nombre: 'Superglue', precio: 1.0 },
                        { nombre: 'Tabla De Multiplicar', precio: 2.0 },
                        { nombre: 'Tabla Peri√≥dica', precio: 2.0 },
                        { nombre: 'Tarjetas De N√∫meros, Abecedarios Y S√≠labas', precio: 6.0 },
                        { nombre: 'Tizas', precio: 0.5 },
                        { nombre: 'T√©mperas', precio: 6.0 },
                        { nombre: 'T√©mperas Individuales (Chicas)', precio: 1.5 },
                        { nombre: 'T√©mperas Vikingo', precio: 7.5 },
                        { nombre: 'Vinifan A4', precio: 6.5 },
                        { nombre: 'Vinifan Oficio', precio: 12.0 },
                        { nombre: 'Vinifancito (Peque√±o)', precio: 3.5 }
                    ]
                },
                { // ----------------- CATEGOR√çA 2: MATERIAL DE OFICINA -----------------
                    id: 'mat_oficina', 
                    name: 'MATERIAL DE OFICINA',
                    products: [
                        { nombre: 'Cinta De Embalaje 15 Yardas', precio: 1.5 },
                        { nombre: 'Cinta Embalaje 110 Yardas', precio: 6.5 },
                        { nombre: 'Cinta Embalaje 70 Yardas', precio: 3.6 },
                        { nombre: 'Embalaje 150 Yardas', precio: 8.0 },
                        { nombre: 'Folder De Colores', precio: 1.2 },
                        { nombre: 'Folder Manila (Con Faster)', precio: 1.0 },
                        { nombre: 'Folder Plastificado', precio: 8.0 },
                        { nombre: 'Folder Platico', precio: 5.0 },
                        { nombre: 'Imperdibles', precio: 0.2 },
                        { nombre: 'Lapicero', precio: 1.0 },
                        { nombre: 'Lapicero Ove', precio: 4.0 },
                        { nombre: 'Lapicero Pilot', precio: 4.0 },
                        { nombre: 'Lapicero Pilot BPS', precio: 3.5 },
                        { nombre: 'Lapicero Pilot Tinta L√≠quida', precio: 6.0 },
                        { nombre: 'Lapicero Vikingo', precio: 4.0 },
                        { nombre: 'Libretas Anilladas', precio: 2.5 },
                        { nombre: 'Libretas Tapa Dura', precio: 1.8 },
                        { nombre: 'Sobre Manila Medio Oficio', precio: 0.5 },
                        { nombre: 'Sobre Manila Oficio U A4', precio: 1.0 },
                        { nombre: 'Tiquera Grande', precio: 7.5 }
                    ]
                },
                { // ----------------- CATEGOR√çA 3: PAPELER√çA -----------------
                    id: 'papeleria', 
                    name: 'PAPELER√çA',
                    products: [
                        { nombre: 'Cartulina Blanca', precio: 0.8 },
                        { nombre: 'Cartulina De Color Fuerte', precio: 1.0 },
                        { nombre: 'Hoja De Color', precio: 0.2 },
                        { nombre: 'Hojas De Color (Varios)', precio: 0.3 },
                        { nombre: 'Papel Bond', precio: 0.1 },
                        { nombre: 'Papel Celofan Decorado', precio: 1.0 },
                        { nombre: 'Papel Fotogr√°fico', precio: 1.0 },
                        { nombre: 'Papel Kraft', precio: 1.0 },
                        { nombre: 'Papel Lustre', precio: 0.5 },
                        { nombre: 'Papel Manteca', precio: 1.0 },
                        { nombre: 'Papel Seda', precio: 0.3 },
                        { nombre: 'Papelotes', precio: 0.5 }
                    ]
                },
                { // ----------------- CATEGOR√çA 4: OTROS (Regalo/Limpieza) -----------------
                    id: 'otros_regalo_limpieza', 
                    name: 'OTROS (Regalo/Limpieza)',
                    products: [
                        { nombre: 'Bola De Regalo Talla L', precio: 4.0 },
                        { nombre: 'Bolsa De Regalo Talla Chiquito', precio: 1.5 },
                        { nombre: 'Bolsa De Regalo Talla M', precio: 2.5 },
                        { nombre: 'Bolsa De Regalo Talla M Z', precio: 3.5 },
                        { nombre: 'Cortina De Cumplea√±os', precio: 5.0 },
                        { nombre: 'Detergente', precio: 2.5 },
                        { nombre: 'Globos', precio: 0.2 },
                        { nombre: 'Inflador De Globos', precio: 5.0 },
                        { nombre: 'Jabon Liquido', precio: 6.0 },
                        { nombre: 'Pa√±os Amarillos', precio: 1.0 },
                        { nombre: 'Pelotas Trapo', precio: 1.0 },
                        { nombre: 'Perchero', precio: 1.5 },
                        { nombre: 'Tarjeta De Cumplea√±os', precio: 0.2 },
                        { nombre: 'Toallas De Mano', precio: 6.0 }
                    ]
                }
            ], 
            isDataLoaded: false
        };
        
        let currentEditingCategory = null; 
        const ADMIN_PASSWORD = '0000';
        const PASSWORD_MODAL_ID = 'passwordModal'; 
        let currentSearchTerm = ''; 
        
        // 3. REFERENCIAS A ELEMENTOS DEL DOM
        const mainMenu = document.getElementById('mainMenu');
        const categoriesView = document.getElementById('categoriesView');
        const productsView = document.getElementById('productsView');
        const recommendationsView = document.getElementById('recommendationsView'); 
        const adminView = document.getElementById('adminView');
        
        const categoriesContainer = document.getElementById('categoriesContainer');
        const productsTitle = document.getElementById('productsTitle');
        const productsListContainer = document.getElementById('productsListContainer');
        const appSubtitle = document.getElementById('appSubtitle');
        const zivaContentContainer = document.getElementById('zivaContentContainer'); 
        const categoryTitle = document.getElementById('categoryTitle'); 
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        const loadingMessage = document.getElementById('loadingMessage'); 
        
        // --- FUNCIONES DE PERSISTENCIA (LOCAL STORAGE FALLBACK) ---
        const LOCAL_CATALOG_KEY = 'miguelito_catalog_data_v2'; // v2 para evitar conflictos

        /** Guarda el cat√°logo en LocalStorage (si falla Firebase). */
        function saveCatalogLocally() {
            try {
                localStorage.setItem(LOCAL_CATALOG_KEY, JSON.stringify(window.appData.categories));
                console.log("Cat√°logo guardado localmente (fallback).");
            } catch (e) {
                console.error("Error al guardar localmente: ", e);
            }
        }

        /** Carga el cat√°logo desde LocalStorage (si falla Firebase). */
        function loadCatalogLocally() {
            try {
                const localData = localStorage.getItem(LOCAL_CATALOG_KEY);
                if (localData) {
                    window.appData.categories = JSON.parse(localData);
                    console.log("Cat√°logo cargado desde LocalStorage.");
                } else {
                    console.log("No hay datos locales, se usar√°n los datos iniciales.");
                    // Los datos iniciales ya est√°n en window.appData.categories
                }
            } catch (e) {
                console.error("Error al cargar localmente: ", e);
            }
            // Marcamos como cargado y ocultamos el mensaje
            window.appData.isDataLoaded = true;
            loadingMessage.classList.add('hidden');
        }
        // --- FIN FUNCIONES DE PERSISTENCIA ---


        /** Guarda la estructura completa del cat√°logo en Firestore (o local si falla). */
        async function saveCatalog() {
            // Si Firebase no se conect√≥ (window.db es null), usa el guardado local.
            if (!window.isFirebaseActive || !window.db) {
                console.warn("Firebase no est√° activo. Guardando localmente (No se sincronizar√°).");
                saveCatalogLocally();
                return;
            }
            
            // CORRECCI√ìN MULTI-USUARIO: Ruta compartida
            const catalogRef = window.doc(window.db, `artifacts/${window.appId}/shared_data`, 'catalog');
            
            try {
                await window.setDoc(catalogRef, { categories: window.appData.categories });
                console.log("Cat√°logo guardado exitosamente en Firestore (Ruta Compartida).");
            } catch (e) {
                console.error("Error al guardar el cat√°logo en Firestore: ", e);
                saveCatalogLocally(); // Intenta guardado local si falla la escritura en Firestore
            }
        }

        /** Inicia la escucha de datos (Firebase o Local). */
        window.startFirebaseListeners = function() {
            // Si Firebase no se conect√≥ (window.db es null), carga localmente.
            if (!window.isFirebaseActive || !window.db) {
                console.warn("Firebase no est√° activo. Cargando datos locales.");
                loadCatalogLocally();
                // Renderiza la vista actual si es necesario
                if (!categoriesView.classList.contains('hidden')) {
                    renderCategoryButtons();
                }
                return;
            }
            
            // CORRECCI√ìN MULTI-USUARIO: Ruta compartida
            const catalogRef = window.doc(window.db, `artifacts/${window.appId}/shared_data`, 'catalog');

            window.onSnapshot(catalogRef, (docSnapshot) => {
                loadingMessage.classList.add('hidden');
                
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    window.appData.categories = data.categories || []; 
                    console.log("Datos de Cat√°logo actualizados desde Firestore (Ruta Compartida).", window.appData.categories.length, "categor√≠as.");
                } else {
                    // Si el documento no existe (primera vez), guarda los datos iniciales en la nube.
                    console.log("Documento de Cat√°logo no encontrado en Firestore. Guardando datos iniciales...");
                    saveCatalog(); 
                }
                window.appData.isDataLoaded = true;
                
                // Forzar re-renderizado
                if (!categoriesView.classList.contains('hidden')) {
                    if (currentSearchTerm.length > 0) {
                         const results = performSearch(currentSearchTerm);
                         renderSearchResults(results, categoriesContainer);
                    } else {
                        renderCategoryButtons();
                    }
                } else if (!adminView.classList.contains('hidden')) {
                    renderAdminCategories();
                    if (currentEditingCategory) {
                        const category = window.appData.categories.find(c => c.id === currentEditingCategory.id);
                        if (category) {
                            currentEditingCategory = category;
                            renderAdminProducts();
                        } else {
                            document.getElementById('adminProductsSection').classList.add('hidden');
                            currentEditingCategory = null;
                        }
                    }
                }
            }, (error) => {
                console.error("Error al escuchar el cat√°logo de Firestore:", error);
                loadingMessage.textContent = 'Error de conexi√≥n. Cargando datos locales.';
                loadCatalogLocally(); // Carga local si hay error de Firestore
                if (!categoriesView.classList.contains('hidden')) {
                    renderCategoryButtons();
                }
            });
        };


        // 2. CONTENIDO DE RECOMENDACIONES DE ZIVA
        const ZIVA_CONTENT = `
            <h2 class="text-3xl title-font font-bold mb-6 border-b pb-2 text-blue-800">Recomendaciones de Ziva</h2>
            <h3 class="text-2xl font-bold text-blue-700 mb-2 title-font">üí¨ ¬°Hola, soy Ziva!</h3>
            <p class="mb-4 text-base">¬°Tu asistente virtual en la tienda! Estoy aqu√≠ para ayudarte a <strong>atender sin perder la cabeza üòÑ</strong>. Sigue estas recomendaciones y todo saldr√° genial:</p>
            <hr class="my-4 border-gray-200">
            <h4 class="text-xl font-semibold text-blue-600 mb-3">üõçÔ∏è ¬øC√≥mo atender a un cliente?</h4>
            <ul class="list-disc pl-6 space-y-3 text-sm sm:text-base">
                <li><strong>Saluda siempre con amabilidad.</strong>
                    <br>Ejemplo: ‚Äú¬°Buenos d√≠as! ¬øEn qu√© puedo ayudarte?‚Äù</li>
                <li><strong>Escucha con atenci√≥n</strong> lo que el cliente pide.</li>
                <li><strong>Confirma el producto y el precio</strong> antes de cobrar.</li>
                <li><strong>Empaca con cuidado</strong> y entrega el producto con una sonrisa.</li>
                <li><strong>Desp√≠dete cordialmente.</strong>
                    <br>Ejemplo: ‚Äú¬°Gracias por tu compra! Que tengas un buen d√≠a.‚Äù</li>
                <li><strong>Siempre da las gracias.</strong></li>
            </ul>
            <hr class="my-4 border-gray-200">
            <h4 class="text-xl font-semibold text-blue-600 mb-3">üí∏ ¬øQu√© hago si no hay vuelto?</h4>
            <ul class="list-disc pl-6 space-y-3 text-sm sm:text-base">
                <li><strong>Informa con cortes√≠a:</strong>
                    <br>‚ÄúDisculpe, por el momento no tengo cambio exacto.‚Äù</li>
                <li><strong>Ofrece soluciones:</strong>
                    <ul class="list-disc pl-6 mt-1 space-y-1">
                        <li>Pregunta si tiene monto exacto.</li>
                        <li>Sugiere otro m√©todo de pago (Yape, Plin, etc.).</li>
                        <li>Busca cambio con otro trabajador o negocio cercano.</li>
                    </ul>
                </li>
                <li><strong>Nunca entregues de m√°s.</strong>
                    <br>Si no se puede resolver, guarda el producto hasta que el cliente regrese con cambio.</li>
            </ul>
            <hr class="my-4 border-gray-200">
            <h4 class="text-xl font-semibold text-blue-600 mb-3">üì¶ Consejo extra de Ziva:</h4>
            <ul class="list-disc pl-6 space-y-3 text-sm sm:text-base">
                <li>Mant√©n siempre tu √°rea limpia y ordenada.</li>
                <li>Revisa los precios actualizados antes de atender.</li>
                <li>Si hay alg√∫n problema o duda, <strong>an√≥talo</strong> y <strong>avisa al encargado</strong>.</li>
            </ul>
        `;

        // 4. FUNCIONES DE VISTA (Control de Pantallas)
        function hideAllViews() {
            mainMenu.classList.add('hidden');
            categoriesView.classList.add('hidden');
            productsView.classList.add('hidden');
            recommendationsView.classList.add('hidden');
            adminView.classList.add('hidden'); 
        }

        function showMainMenu() {
            hideAllViews();
            mainMenu.classList.remove('hidden');
            appSubtitle.textContent = 'Portal de Recursos para Asesores de Venta';
        }

        function showCategories() {
            hideAllViews();
            categoriesView.classList.remove('hidden');
            appSubtitle.textContent = 'M√≥dulo de Precios';
            if(window.appData.isDataLoaded) {
                document.getElementById('searchInput').value = '';
                currentSearchTerm = '';
                categoryTitle.textContent = 'Seleccione una Categor√≠a';
                renderCategoryButtons(); 
            } else {
                // Si la data a√∫n no carga (raro, pero posible), mostramos el mensaje
                loadingMessage.classList.remove('hidden');
            }
        }

        function showProducts(categoryName) {
            hideAllViews();
            productsView.classList.remove('hidden');
            productsTitle.textContent = `Lista de Precios: ${categoryName}`;
            appSubtitle.textContent = `Precios: ${categoryName}`;
            renderProductList(categoryName);
        }
        
        function showRecommendations() {
            hideAllViews();
            zivaContentContainer.innerHTML = ZIVA_CONTENT; 
            recommendationsView.classList.remove('hidden');
            appSubtitle.textContent = 'Recomendaciones de Ziva';
            lucide.createIcons(); 
        }

        function showAdminView() {
            hideAllViews();
            adminView.classList.remove('hidden');
            renderAdminCategories();
            appSubtitle.textContent = 'MODO JEFE ACTIVADO (Edici√≥n de Cat√°logo)';
        }

        function exitAdminMode() {
            currentEditingCategory = null;
            document.getElementById('adminProductsSection').classList.add('hidden');
            showMainMenu();
        }

        // 5. FUNCIONES DE RENDERIZADO (CLIENTE)
        function renderCategoryButtons() {
            if (currentSearchTerm.length > 0) return; 
            categoriesContainer.innerHTML = ''; 
            categoriesContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4';
            loadingMessage.classList.add('hidden');

            if (window.appData.categories.length === 0 && window.appData.isDataLoaded) {
                 categoriesContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-6">El cat√°logo est√° vac√≠o. El modo JEFE debe agregar categor√≠as.</p>`;
                 return;
            }
            
            window.appData.categories.forEach(category => {
                const icon = getCategoryIcon(category.name);
                const buttonHtml = `
                    <button class="category-button flex flex-col items-center justify-center p-4 rounded-xl h-32 text-center"
                            onclick="showProducts('${category.name.replace(/'/g, "\\'")}')">
                        <i data-lucide="${icon}" class="w-6 h-6 mb-1"></i>
                        <span class="text-base font-semibold">${category.name}</span>
                    </button>
                `;
                categoriesContainer.innerHTML += buttonHtml;
            });
            lucide.createIcons(); 
        }

        function renderProductList(categoryName) {
            const category = window.appData.categories.find(c => c.name === categoryName);
            const products = category ? category.products : [];
            productsListContainer.innerHTML = ''; 

            if (!products || products.length === 0) {
                productsListContainer.innerHTML = `<p class="p-4 text-gray-500">No hay productos disponibles en esta categor√≠a.</p>`;
                return;
            }
            
            productsListContainer.innerHTML = `
                <div class="price-table-header">
                    <div class="flex justify-between items-center">
                        <span class="w-3/4">Producto</span>
                        <span class="w-1/4 text-right">Precio (S/)</span>
                    </div>
                </div>
            `;

            const listHtml = products.map(item => {
                return `
                    <div class="price-item text-sm sm:text-base hover:bg-gray-50">
                        <span class="w-3/4 font-medium text-gray-800">${item.nombre}</span>
                        <span class="w-1/4 text-right font-bold text-lg text-green-600">S/${parseFloat(item.precio).toFixed(2)}</span>
                    </div>
                `;
            }).join('');

            productsListContainer.innerHTML += listHtml;
        }
        
        // 6. FUNCIONES DE B√öSQUEDA
        function liveSearch() {
            currentSearchTerm = document.getElementById('searchInput').value.trim();
            if (window.searchTimeout) {
                clearTimeout(window.searchTimeout);
            }
            window.searchTimeout = setTimeout(() => {
                if (currentSearchTerm.length > 0) {
                    const results = performSearch(currentSearchTerm);
                    renderSearchResults(results, categoriesContainer);
                    categoryTitle.textContent = `Resultados de B√∫squeda`;
                } else {
                    categoryTitle.textContent = 'Seleccione una Categor√≠a';
                    renderCategoryButtons(); 
                }
                lucide.createIcons(); 
            }, 300);
        }

        function performSearch(term) {
            const lowerCaseTerm = term.toLowerCase();
            const allProducts = [];
            window.appData.categories.forEach(category => {
                category.products.forEach(product => {
                    if (product.nombre.toLowerCase().includes(lowerCaseTerm)) {
                        allProducts.push({
                            nombre: product.nombre,
                            precio: product.precio,
                            categoria: category.name
                        });
                    }
                });
            });
            return allProducts;
        }

        function renderSearchResults(results, container) {
            container.innerHTML = ''; 
            container.className = 'flex flex-col gap-2'; 
            if (results.length === 0) {
                 container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-6">No se encontraron productos que coincidan con la b√∫squeda "${currentSearchTerm}".</p>`;
                 return;
            }
            const listHtml = results.map(item => {
                return `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-blue-50 transition-colors">
                        <div class="min-w-0 flex-1">
                            <span class="font-semibold text-gray-800 block truncate">${item.nombre}</span>
                            <span class="text-xs text-gray-500 block">Categor√≠a: ${item.categoria}</span>
                        </div>
                        <span class="text-right font-bold text-lg text-green-600 ml-4">S/${parseFloat(item.precio).toFixed(2)}</span>
                    </div>
                `;
            }).join('');
            container.innerHTML = listHtml;
        }
        
        // 7. UTILIDADES Y MODAL
        function getCategoryIcon(categoryName) {
            const normalizedName = categoryName.toUpperCase();
            if (normalizedName.includes('ESCOLAR') || normalizedName.includes('√öTILES')) return 'pencil-ruler';
            if (normalizedName.includes('OFICINA') || normalizedName.includes('ESCRITORIO')) return 'clipboard';
            if (normalizedName.includes('PAPELER√çA') || normalizedName.includes('PAPEL')) return 'layers';
            if (normalizedName.includes('LIBROS') || normalizedName.includes('LECTURA')) return 'book-open';
            if (normalizedName.includes('REGALO') || normalizedName.includes('OTROS')) return 'gift';
            return 'package';
        }

        function showMessage(title, message) {
            modalContent.innerHTML = `
                <h3 class="text-2xl font-bold title-font mb-4 text-center">${title}</h3>
                ${message}
            `;
            modal.style.display = 'flex';
        }

        function hideModal(event) {
            if (!event || event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 8. MODO ADMINISTRADOR (JEFE)
        function showAdminPasswordModal() {
            showMessage('Acceso de Administrador', `
                <p class="text-gray-600 mb-4 text-center">Ingrese la contrase√±a para acceder al modo de edici√≥n.</p>
                <input type="password" id="adminPasswordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-2 text-center text-lg tracking-widest" placeholder="Contrase√±a">
                <div id="passwordError" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <button onclick="checkAdminPassword()"
                        class="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                    Ingresar
                </button>
            `);
            document.getElementById('adminPasswordInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    checkAdminPassword();
                }
            });
        }

        function checkAdminPassword() {
            const input = document.getElementById('adminPasswordInput');
            const errorDiv = document.getElementById('passwordError');
            if (input.value === ADMIN_PASSWORD) {
                hideModal();
                showAdminView();
            } else {
                errorDiv.textContent = 'Contrase√±a incorrecta. (Pista: 0000)';
                errorDiv.classList.remove('hidden');
                input.value = '';
            }
        }
        
        // 9. FUNCIONES CRUD (ADMIN)
        // (Estas funciones ahora llaman a saveCatalog(), que guarda en Firebase o Local)
        function renderAdminCategories() {
            const container = document.getElementById('adminCategoriesContainer');
            container.innerHTML = '';
            document.getElementById('adminProductsSection').classList.add('hidden'); 
            currentEditingCategory = null;

            if (window.appData.categories.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">A√∫n no hay categor√≠as creadas. ¬°Empieza por a√±adir una!</p>`;
                return;
            }

            window.appData.categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 bg-white rounded-lg shadow-sm border border-red-100';
                div.innerHTML = `
                    <span class="font-semibold text-gray-700 mb-2 sm:mb-0">${cat.name} (${cat.products.length} productos)</span>
                    <div class="flex space-x-2">
                        <button onclick="selectCategoryForEditing('${cat.id}', '${cat.name.replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-50 transition-colors" title="Ver Productos">
                            <i data-lucide="list-checks" class="w-5 h-5"></i>
                        </button>
                        <button onclick="showEditCategoryModal('${cat.id}', '${cat.name.replace(/'/g, "\\'")}')" class="text-yellow-600 hover:text-yellow-800 p-1 rounded-full hover:bg-yellow-50 transition-colors" title="Renombrar">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <button onclick="showConfirmDeleteCategory('${cat.id}', '${cat.name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-50 transition-colors" title="Eliminar Categor√≠a">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function addCategory() {
            const name = document.getElementById('newCategoryNameInput').value.trim();
            if (name) {
                const id = crypto.randomUUID(); 
                window.appData.categories.push({ id: id, name: name, products: [] });
                saveCatalog(); // <-- Guarda en Firebase/Local
                renderAdminCategories();
                hideModal();
            } else {
                showMessage('Error', '<p class="text-red-600 text-center">El nombre de la categor√≠a no puede estar vac√≠o.</p><button onclick="hideModal(event)" class="w-full mt-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition duration-150 shadow-md">Cerrar</button>');
            }
        }

        function showAddCategoryModal() {
            showMessage('A√±adir Nueva Categor√≠a', `
                <p class="text-gray-600 mb-4">Ingresa el nombre de la nueva categor√≠a:</p>
                <input type="text" id="newCategoryNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-4" placeholder="Ej: √ötiles de Arte">
                <button onclick="addCategory()"
                        class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                    Crear Categor√≠a
                </button>
            `);
        }
        
        function showEditCategoryModal(id, currentName) {
            showMessage('Editar Categor√≠a', `
                <p class="text-gray-600 mb-4">Renombrar categor√≠a: <strong>${currentName}</strong></p>
                <input type="text" id="editCategoryNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 mb-4" value="${currentName}">
                <button onclick="updateCategoryName('${id}')"
                        class="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                    Guardar Nombre
                </button>
            `);
        }

        function updateCategoryName(id) {
            const newName = document.getElementById('editCategoryNameInput').value.trim();
            if (newName) {
                const category = window.appData.categories.find(c => c.id === id);
                if (category) {
                    category.name = newName;
                    saveCatalog(); // <-- Guarda en Firebase/Local
                    if(currentEditingCategory && currentEditingCategory.id === id) {
                        currentEditingCategory.name = newName;
                        document.getElementById('adminProductsTitle').textContent = `Productos en ${newName}`;
                    }
                    renderAdminCategories();
                    hideModal();
                }
            } else {
                showMessage('Error', '<p class="text-red-600 text-center">El nombre no puede estar vac√≠o.</p><button onclick="hideModal(event)" class="w-full mt-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition duration-150 shadow-md">Cerrar</button>');
            }
        }
        
        function showConfirmDeleteCategory(id, name) {
            showMessage('Confirmar Eliminaci√≥n', `
                <p class="text-lg font-bold text-red-600 text-center mb-4">¬øEst√°s seguro que deseas eliminar la categor√≠a "<strong>${name}</strong>"?</p>
                <p class="text-sm text-gray-600 text-center mb-6">Se eliminar√°n tambi√©n todos los ${window.appData.categories.find(c => c.id === id)?.products.length || 0} productos asociados.</p>
                <div class="flex justify-around space-x-4">
                    <button onclick="hideModal(event)"
                            class="flex-1 py-2 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold rounded-lg transition duration-150">
                        Cancelar
                    </button>
                    <button onclick="deleteCategory('${id}')"
                            class="flex-1 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                        Eliminar
                    </button>
                </div>
            `);
        }
        
        function deleteCategory(id) {
            window.appData.categories = window.appData.categories.filter(c => c.id !== id);
            saveCatalog(); // <-- Guarda en Firebase/Local
            renderAdminCategories();
            hideModal();
        }
        
        function selectCategoryForEditing(id, name) {
            const category = window.appData.categories.find(c => c.id === id);
            if (category) {
                currentEditingCategory = category;
                document.getElementById('adminProductsTitle').textContent = `Productos en ${name}`;
                document.getElementById('adminProductsSection').classList.remove('hidden');
                renderAdminProducts();
            }
        }

        function renderAdminProducts() {
            const list = document.getElementById('adminProductsList');
            list.innerHTML = '';

            if (!currentEditingCategory || currentEditingCategory.products.length === 0) {
                list.innerHTML = `<p class="p-4 text-gray-500 text-center">No hay productos en esta categor√≠a. Usa el bot√≥n "A√±adir Producto".</p>`;
                return;
            }
            
            currentEditingCategory.products.forEach((product, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <span class="font-semibold text-gray-700 block truncate">${product.nombre}</span>
                        <span class="text-sm text-green-600 font-bold">S/${parseFloat(product.precio).toFixed(2)}</span>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="showEditProductModal('${currentEditingCategory.id}', ${index}, '${product.nombre.replace(/'/g, "\\'")}', ${product.precio})" class="text-yellow-600 hover:text-yellow-800 p-1 rounded-full hover:bg-yellow-50 transition-colors" title="Editar Producto">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <button onclick="showConfirmDeleteProduct('${currentEditingCategory.id}', ${index}, '${product.nombre.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-50 transition-colors" title="Eliminar Producto">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });

            lucide.createIcons();
        }

        function showAddProductModal() {
            const categoryName = currentEditingCategory ? currentEditingCategory.name : 'la categor√≠a';
            showMessage('A√±adir Nuevo Producto', `
                <p class="text-gray-600 mb-4">Ingresa los detalles para <strong>${categoryName}</strong>:</p>
                <div class="space-y-3">
                    <input type="text" id="productNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Nombre del Producto">
                    <input type="number" step="0.01" id="productPriceInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Precio (S/ 0.00)">
                </div>
                <button onclick="addProduct()"
                        class="w-full mt-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                    Guardar Producto
                </button>
            `);
        }

        function addProduct() {
            if (!currentEditingCategory) return;
            const name = document.getElementById('productNameInput').value.trim();
            const price = parseFloat(document.getElementById('productPriceInput').value);

            if (name && !isNaN(price) && price >= 0) {
                currentEditingCategory.products.push({ nombre: name, precio: price });
                const index = window.appData.categories.findIndex(c => c.id === currentEditingCategory.id);
                if (index !== -1) {
                    window.appData.categories[index] = currentEditingCategory;
                }
                saveCatalog(); // <-- Guarda en Firebase/Local
                renderAdminProducts();
                hideModal();
            } else {
                showMessage('Error', '<p class="text-red-600 text-center">Por favor, ingresa un nombre v√°lido y un precio positivo.</p><button onclick="hideModal(event)" class="w-full mt-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition duration-150 shadow-md">Cerrar</button>');
            }
        }
        
        function showEditProductModal(categoryId, index, name, price) {
            showMessage('Editar Producto', `
                <p class="text-gray-600 mb-4">Editando: <strong>${name}</strong></p>
                <div class="space-y-3">
                    <input type="text" id="editProductNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" value="${name}" placeholder="Nombre del Producto">
                    <input type="number" step="0.01" id="editProductPriceInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" value="${parseFloat(price).toFixed(2)}" placeholder="Precio (S/ 0.00)">
                </div>
                <button onclick="updateProduct('${categoryId}', ${index})"
                        class="w-full mt-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                    Guardar Cambios
                </button>
            `);
        }

        function updateProduct(categoryId, index) {
            const newName = document.getElementById('editProductNameInput').value.trim();
            const newPrice = parseFloat(document.getElementById('editProductPriceInput').value);

            if (newName && !isNaN(newPrice) && newPrice >= 0) {
                const category = window.appData.categories.find(c => c.id === categoryId);
                if (category && category.products[index]) {
                    category.products[index].nombre = newName;
                    category.products[index].precio = newPrice;
                    if (currentEditingCategory && currentEditingCategory.id === categoryId) {
                        currentEditingCategory.products[index] = category.products[index];
                    }
                    saveCatalog(); // <-- Guarda en Firebase/Local
                    renderAdminProducts();
                    hideModal();
                }
            } else {
                showMessage('Error', '<p class="text-red-600 text-center">Por favor, ingresa un nombre v√°lido y un precio positivo.</p><button onclick="hideModal(event)" class="w-full mt-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition duration-150 shadow-md">Cerrar</button>');
            }
        }
        
        function showConfirmDeleteProduct(categoryId, index, name) {
            showMessage('Confirmar Eliminaci√≥n de Producto', `
                <p class="text-lg font-bold text-red-600 text-center mb-4">¬øDeseas eliminar el producto "<strong>${name}</strong>"?</p>
                <div class="flex justify-around space-x-4">
                    <button onclick="hideModal(event)"
                            class="flex-1 py-2 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold rounded-lg transition duration-150">
                        Cancelar
                    </button>
                    <button onclick="deleteProduct('${categoryId}', ${index})"
                            class="flex-1 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150 shadow-md">
                        Eliminar
                    </button>
                </div>
            `);
        }

        function deleteProduct(categoryId, index) {
            const category = window.appData.categories.find(c => c.id === categoryId);
            if (category && category.products[index]) {
                category.products.splice(index, 1);
                if (currentEditingCategory && currentEditingCategory.id === categoryId) {
                    currentEditingCategory.products = category.products;
                }
                saveCatalog(); // <-- Guarda en Firebase/Local
                renderAdminProducts();
                hideModal();
            }
        }
        
        // Inicializaci√≥n: Asegurar que el men√∫ principal se muestre al cargar
        document.addEventListener('DOMContentLoaded', showMainMenu);

    </script>
</body>
</html>
